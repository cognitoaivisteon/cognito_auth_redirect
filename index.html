<!DOCTYPE html>
<html>
<head>
    <title>Device Connection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f8ff; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; }
        .car-icon { font-size: 50px; text-align: center; margin-bottom: 20px; }
        .button { background: #4285f4; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 16px; width: 100%; margin: 10px 0; }
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; }
        .success { background: #d4edda; color: #155724; }
        .loading { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <div class="car-icon"></div>
        <h1>Connect to Your device</h1>
        
        <div id="login-section">
            <p>Sign in with Google to connect your Gmail and Calendar.</p>
            <button class="button" onclick="signInWithGoogle()">
                Sign in with Google
            </button>
        </div>
        
        <div id="connected-section" style="display: none;">
            <div class="status success">
                <strong>âœ… Connected to device!</strong><br>
                Your device can now access your Gmail and Calendar.
            </div>
            <p><strong>Connected as:</strong> <span id="user-email"></span></p>
            <button class="button" onclick="disconnect()">Disconnect</button>
        </div>
        
        <div id="loading-section" style="display: none;">
            <div class="status loading">
                Connecting to Google...
            </div>
        </div>
    </div>

    <script>
        // Google OAuth configuration
        const CLIENT_ID = '840725329059-o6g0m383kuqcp8qgscbuho592p1oorbj.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/gmail.modify';
        
        let accessToken = null;
        let userEmail = null;
        
        // Initialize Google API
        function initGoogleAPI() {
            gapi.load('auth2', function() {
                gapi.auth2.init({
                    client_id: CLIENT_ID,
                    scope: SCOPES
                });
            });
        }
        
        // Sign in with Google
        function signInWithGoogle() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'block';
            
            const authInstance = gapi.auth2.getAuthInstance();
            authInstance.signIn().then(function(googleUser) {
                const profile = googleUser.getBasicProfile();
                const authResponse = googleUser.getAuthResponse();
                
                accessToken = authResponse.access_token;
                userEmail = profile.getEmail();
                
                // Store in localStorage for system to access
                localStorage.setItem('access_token', accessToken);
                localStorage.setItem('user_email', userEmail);
                localStorage.setItem('connected_time', Date.now());
                
                showConnectedState();
                startDataSync();
                
            }).catch(function(error) {
                console.error('Sign in failed:', error);
                showLoginState();
            });
        }
        
        // Show connected state
        function showConnectedState() {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('connected-section').style.display = 'block';
            document.getElementById('user-email').textContent = userEmail;
        }
        
        // Show login state
        function showLoginState() {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('connected-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
        }
        
        // Start syncing data for device
        function startDataSync() {
            // Fetch Gmail data
            fetchGmailData();
            // Fetch Calendar data  
            fetchCalendarData();
            
            // Refresh data every 30 seconds
            setInterval(() => {
                if (accessToken) {
                    fetchGmailData();
                    fetchCalendarData();
                }
            }, 30000);
        }
        
        // Fetch Gmail data
        function fetchGmailData() {
            fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=10&q=is:unread`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            }).then(response => response.json())
              .then(data => {
                  localStorage.setItem('gmail_data', JSON.stringify(data));
              });
        }
        
        // Fetch Calendar data
        function fetchCalendarData() {
            const now = new Date().toISOString();
            fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${now}&maxResults=10&singleEvents=true&orderBy=startTime`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            }).then(response => response.json())
              .then(data => {
                  localStorage.setItem('calendar_data', JSON.stringify(data));
              });
        }
        
        // Disconnect
        function disconnect() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_email');
            localStorage.removeItem('gmail_data');
            localStorage.removeItem('calendar_data');
            
            gapi.auth2.getAuthInstance().signOut();
            showLoginState();
        }
        
        // Check existing connection on page load
        window.onload = function() {
            const savedToken = localStorage.getItem('access_token');
            const savedEmail = localStorage.getItem('user_email');
            
            if (savedToken && savedEmail) {
                accessToken = savedToken;
                userEmail = savedEmail;
                showConnectedState();
                startDataSync();
            }
        };
    </script>
    
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js" onload="initGoogleAPI()"></script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>My Car - Phone Connection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container { 
            max-width: 400px; 
            margin: 50px auto; 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .car-icon { 
            font-size: 60px; 
            text-align: center; 
            margin-bottom: 20px; 
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        .button { 
            background: linear-gradient(45deg, #4285f4, #34a853); 
            color: white; 
            padding: 15px 30px; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            width: 100%; 
            margin: 15px 0; 
            cursor: pointer;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .status { 
            padding: 20px; 
            border-radius: 12px; 
            margin: 20px 0; 
            text-align: center; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 2px solid #c3e6cb;
        }
        .loading { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 2px solid #b8daff;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        h1 { 
            text-align: center; 
            color: #333; 
            margin-bottom: 30px;
        }
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        #g_id_onload {
            position: absolute;
            top: -1000px;
            left: -1000px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="car-icon">üöó</div>
        <h1>Connect to Your Car</h1>
        
        <div id="login-section">
            <p>Sign in with Google to connect your Gmail and Calendar to your car.</p>
            <div id="g_id_onload"
                 data-client_id="YOUR_CLIENT_ID.googleusercontent.com"
                 data-callback="handleGoogleSignIn"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" 
                 data-type="standard"
                 data-size="large"
                 data-theme="outline"
                 data-text="sign_in_with"
                 data-shape="rectangular"
                 data-logo_alignment="left"
                 data-width="100%">
            </div>
            <button class="button" onclick="triggerGoogleSignIn()" style="margin-top: 20px;">
                üîê Sign in with Google
            </button>
        </div>
        
        <div id="connected-section" style="display: none;">
            <div class="status success">
                <strong>‚úÖ Connected to Car!</strong><br>
                Your car can now access your Gmail and Calendar.
            </div>
            <div class="user-info">
                <strong>Connected as:</strong><br>
                <span id="user-name"></span><br>
                <span id="user-email"></span>
            </div>
            <div id="data-status"></div>
            <button class="button" onclick="refreshData()">üîÑ Refresh Data</button>
            <button class="button" onclick="disconnect()" style="background: #dc3545;">
                üîå Disconnect
            </button>
        </div>
        
        <div id="loading-section" style="display: none;">
            <div class="status loading">
                <strong>üîÑ Connecting to Google...</strong><br>
                Please wait while we authenticate your account.
            </div>
        </div>

        <div id="error-section" style="display: none;">
            <div class="status error">
                <strong>‚ùå Connection Failed</strong><br>
                <span id="error-message"></span>
            </div>
            <button class="button" onclick="showLoginState()">Try Again</button>
        </div>
    </div>

    <script>
        // Replace with your actual Google OAuth Client ID
        const CLIENT_ID = '840725329059-o6g0m383kuqcp8qgscbuho592p1oorbj.apps.googleusercontent.com';
        
        // Scopes for Gmail and Calendar access
        const SCOPES = [
            'https://www.googleapis.com/auth/gmail.readonly',
            'https://www.googleapis.com/auth/calendar.readonly',
            'https://www.googleapis.com/auth/userinfo.profile',
            'https://www.googleapis.com/auth/userinfo.email'
        ].join(' ');
        
        let accessToken = null;
        let userInfo = null;
        
        // Handle Google Sign-In response (new method)
        function handleGoogleSignIn(response) {
            if (response.credential) {
                showLoadingState();
                
                // Decode the JWT token to get user info
                const userInfoFromJWT = parseJWT(response.credential);
                userInfo = {
                    name: userInfoFromJWT.name,
                    email: userInfoFromJWT.email,
                    picture: userInfoFromJWT.picture
                };
                
                // Now get access token for API calls
                getAccessToken();
            } else {
                showError('Sign-in failed. Please try again.');
            }
        }
        
        // Alternative sign-in trigger
        function triggerGoogleSignIn() {
            showLoadingState();
            
            // Use OAuth 2.0 flow for getting access tokens
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` + 
                `client_id=${CLIENT_ID}&` +
                `response_type=token&` +
                `scope=${encodeURIComponent(SCOPES)}&` +
                `redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}`;
                
            window.location.href = authUrl;
        }
        
        // Get access token for API calls
        function getAccessToken() {
            // Use the newer OAuth 2.0 implicit flow
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` + 
                `client_id=${CLIENT_ID}&` +
                `response_type=token&` +
                `scope=${encodeURIComponent(SCOPES)}&` +
                `redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&` +
                `include_granted_scopes=true&` +
                `state=auth`;
                
            window.location.href = authUrl;
        }
        
        // Parse JWT token
        function parseJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error parsing JWT:', error);
                return {};
            }
        }
        
        // Check for access token in URL (OAuth redirect)
        function checkForAccessToken() {
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const token = urlParams.get('access_token');
            const state = urlParams.get('state');
            
            if (token && state === 'auth') {
                accessToken = token;
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Get user info if we don't have it
                if (!userInfo) {
                    getUserInfo(token);
                } else {
                    saveConnectionData();
                    showConnectedState();
                    startDataSync();
                }
            }
        }
        
        // Get user info from Google API
        function getUserInfo(token) {
            fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                userInfo = data;
                saveConnectionData();
                showConnectedState();
                startDataSync();
            })
            .catch(error => {
                console.error('Error getting user info:', error);
                showError('Failed to get user information.');
            });
        }
        
        // Save connection data to localStorage
        function saveConnectionData() {
            const connectionData = {
                accessToken: accessToken,
                userInfo: userInfo,
                connectedTime: Date.now()
            };
            
            localStorage.setItem('connection_data', JSON.stringify(connectionData));
            localStorage.setItem('access_token', accessToken);
            localStorage.setItem('user_email', userInfo.email);
            localStorage.setItem('user_name', userInfo.name);
        }
        
        // Show different states
        function showLoginState() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('connected-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('error-section').style.display = 'none';
        }
        
        function showLoadingState() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('connected-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('error-section').style.display = 'none';
        }
        
        function showConnectedState() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('connected-section').style.display = 'block';
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('error-section').style.display = 'none';
            
            if (userInfo) {
                document.getElementById('user-name').textContent = userInfo.name;
                document.getElementById('user-email').textContent = userInfo.email;
            }
        }
        
        function showError(message) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('connected-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('error-section').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }
        
        // Start syncing data for car
        function startDataSync() {
            if (!accessToken) return;
            
            updateDataStatus('üîÑ Syncing data...');
            
            // Fetch Gmail and Calendar data
            Promise.all([
                fetchGmailData(),
                fetchCalendarData()
            ]).then(() => {
                updateDataStatus('‚úÖ Data synced successfully');
                
                // Refresh data every 30 seconds
                setInterval(() => {
                    if (accessToken) {
                        fetchGmailData();
                        fetchCalendarData();
                    }
                }, 30000);
            }).catch(error => {
                updateDataStatus('‚ùå Failed to sync data');
                console.error('Sync error:', error);
            });
        }
        
        // Update data status display
        function updateDataStatus(message) {
            document.getElementById('data-status').innerHTML = 
                `<div style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin: 10px 0; text-align: center;">
                    ${message}
                </div>`;
        }
        
        // Fetch Gmail data
        function fetchGmailData() {
            return fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=10&q=is:unread', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Gmail API error');
                return response.json();
            })
            .then(data => {
                localStorage.setItem('gmail_data', JSON.stringify(data));
                console.log('Gmail data synced:', data.messages?.length || 0, 'unread messages');
            })
            .catch(error => {
                console.error('Gmail sync error:', error);
            });
        }
        
        // Fetch Calendar data
        function fetchCalendarData() {
            const now = new Date().toISOString();
            return fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${now}&maxResults=10&singleEvents=true&orderBy=startTime`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Calendar API error');
                return response.json();
            })
            .then(data => {
                localStorage.setItem('calendar_data', JSON.stringify(data));
                console.log('Calendar data synced:', data.items?.length || 0, 'upcoming events');
            })
            .catch(error => {
                console.error('Calendar sync error:', error);
            });
        }
        
        // Refresh data manually
        function refreshData() {
            if (accessToken) {
                startDataSync();
            }
        }
        
        // Disconnect
        function disconnect() {
            // Clear all stored data
            localStorage.removeItem('connection_data');
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_email');
            localStorage.removeItem('user_name');
            localStorage.removeItem('gmail_data');
            localStorage.removeItem('calendar_data');
            
            // Reset variables
            accessToken = null;
            userInfo = null;
            
            // Show login state
            showLoginState();
            
            // Revoke token (optional)
            if (accessToken) {
                fetch(`https://oauth2.googleapis.com/revoke?token=${accessToken}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                });
            }
        }
        
        // Check existing connection on page load
        window.onload = function() {
            // First check if we're returning from OAuth
            checkForAccessToken();
            
            // Then check if we have saved connection
            const savedConnection = localStorage.getItem('connection_data');
            if (savedConnection && !accessToken) {
                try {
                    const connectionData = JSON.parse(savedConnection);
                    accessToken = connectionData.accessToken;
                    userInfo = connectionData.userInfo;
                    
                    // Check if token is still valid (simple check)
                    if (accessToken && userInfo) {
                        showConnectedState();
                        startDataSync();
                    } else {
                        showLoginState();
                    }
                } catch (error) {
                    console.error('Error loading saved connection:', error);
                    showLoginState();
                }
            } else if (!accessToken) {
                showLoginState();
            }
        };
    </script>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>